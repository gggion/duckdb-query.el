#+title: duckdb-query

* Benchmarks
Time to convert json output from duckdb into each data structure, alist is the baseline for columnar and org-table:

#+begin_src elisp
(duckdb-query-bench-tabulate
 (duckdb-query-bench-runner
  "https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet"
  :row-sizes '(100000) :iterations 1))
#+end_src

| Benchmark                   | Mean    | Min   | Max   | N |
|-----------------------------+---------+-------+-------+---|
| 100k rows-:alist            | 1.26s   | 1.26s | 1.26s | 1 |
| 100k rows-:plist            | 1.36s   | 1.36s | 1.36s | 1 |
| 100k rows-:hash             | 1.38s   | 1.38s | 1.38s | 1 |
| 100k rows-:vector           | 1.37s   | 1.37s | 1.37s | 1 |
| 100k rows-:columnar         | 1.41s   | 1.41s | 1.41s | 1 |
| 100k rows-:org-table        | 1.32s   | 1.32s | 1.32s | 1 |
| 100k rows-columnar-overhead | 11.79ms |       |       |   |

* Output Formats
- alist ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :alist)
#+end_src

#+RESULTS:
#+begin_src elisp
(((VendorID . 1) (tpep_pickup_datetime . "2025-07-01 00:29:37")
  (tpep_dropoff_datetime . "2025-07-01 00:45:30") (PULocationID . 138))
 ((VendorID . 1) (tpep_pickup_datetime . "2025-07-01 00:23:28")
  (tpep_dropoff_datetime . "2025-07-01 01:07:44") (PULocationID . 132)))
#+end_src

- plist ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :plist)
#+end_src

#+RESULTS:
#+begin_src elisp
((:VendorID 1 :tpep_pickup_datetime "2025-07-01 00:29:37" :tpep_dropoff_datetime
            "2025-07-01 00:45:30" :PULocationID 138)
 (:VendorID 1 :tpep_pickup_datetime "2025-07-01 00:23:28" :tpep_dropoff_datetime
            "2025-07-01 01:07:44" :PULocationID 132))
#+end_src

- hash table ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :hash)
#+end_src

#+RESULTS:
#+begin_src elisp
(#s(hash-table test equal data
               ("VendorID" 1 "tpep_pickup_datetime" "2025-07-01 00:29:37"
                "tpep_dropoff_datetime" "2025-07-01 00:45:30" "PULocationID" 138))
   #s(hash-table test equal data
                 ("VendorID" 1 "tpep_pickup_datetime" "2025-07-01 00:23:28"
                  "tpep_dropoff_datetime" "2025-07-01 01:07:44" "PULocationID"
                  132)))
#+end_src

- vector ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :vector)
#+end_src

#+RESULTS:
#+begin_src elisp
[((VendorID . 1) (tpep_pickup_datetime . "2025-07-01 00:29:37")
  (tpep_dropoff_datetime . "2025-07-01 00:45:30") (PULocationID . 138))
 ((VendorID . 1) (tpep_pickup_datetime . "2025-07-01 00:23:28")
  (tpep_dropoff_datetime . "2025-07-01 01:07:44") (PULocationID . 132))]
#+end_src

- columnar alist ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :columnar)
#+end_src

#+RESULTS:
#+begin_src elisp
((VendorID . [1 1])
 (tpep_pickup_datetime . ["2025-07-01 00:29:37" "2025-07-01 00:23:28"])
 (tpep_dropoff_datetime . ["2025-07-01 00:45:30" "2025-07-01 01:07:44"])
 (PULocationID . [138 132]))
#+end_src
*  org-table 
- elisp representation (:results code) ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :org-table)
#+end_src

#+RESULTS:
#+begin_src elisp
((VendorID tpep_pickup_datetime tpep_dropoff_datetime PULocationID)
 (1 "2025-07-01 00:29:37" "2025-07-01 00:45:30" 138)
 (1 "2025-07-01 00:23:28" "2025-07-01 01:07:44" 132))
#+end_src

- table view (:results table) ::
#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT #1,#2,#3,#8 FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 2"
 :format :org-table)
#+end_src

#+RESULTS:
| VendorID | tpep_pickup_datetime | tpep_dropoff_datetime | PULocationID |
|        1 | 2025-07-01 00:29:37  | 2025-07-01 00:45:30   |          138 |
|        1 | 2025-07-01 00:23:28  | 2025-07-01 01:07:44   |          132 |



* EXAMPLE: All columns - columnar output

#+begin_src elisp :exports both :results code
(duckdb-query 
 "SELECT * FROM 'https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2025-07.parquet' LIMIT 20"
 :format :columnar)
#+end_src

#+RESULTS:
#+begin_src elisp
((VendorID . [1 1 2 2 2 1 2 2 2 2 7 2 2 2 1 1 2 2 2 1])
 (tpep_pickup_datetime
  . ["2025-07-01 00:29:37" "2025-07-01 00:23:28" "2025-07-01 00:53:50"
     "2025-07-01 00:58:49" "2025-07-01 00:09:22" "2025-07-01 00:39:14"
     "2025-07-01 00:15:26" "2025-07-01 00:40:58" "2025-07-01 00:28:12"
     "2025-07-01 00:38:17" "2025-07-01 00:44:56" "2025-07-01 00:39:13"
     "2025-07-01 00:43:37" "2025-07-01 00:58:09" "2025-07-01 00:02:08"
     "2025-07-01 00:30:34" "2025-07-01 00:24:18" "2025-07-01 00:53:28"
     "2025-07-01 00:26:21" "2025-07-01 00:17:22"])
 (tpep_dropoff_datetime
  . ["2025-07-01 00:45:30" "2025-07-01 01:07:44" "2025-07-01 01:27:12"
     "2025-07-01 01:15:55" "2025-07-01 00:23:54" "2025-07-01 00:55:21"
     "2025-07-01 00:29:39" "2025-07-01 00:44:15" "2025-07-01 00:39:49"
     "2025-07-01 00:55:44" "2025-07-01 00:44:56" "2025-07-01 01:09:25"
     "2025-07-01 01:05:36" "2025-07-01 01:25:53" "2025-07-01 00:10:15"
     "2025-07-01 00:40:46" "2025-07-01 00:43:27" "2025-07-01 01:01:26"
     "2025-07-01 00:34:25" "2025-07-01 00:40:14"])
 (passenger_count . [1 1 1 1 1 1 1 1 2 1 1 1 1 2 1 1 1 1 2 1])
 (trip_distance
  . [7.3 17.7 9.98 10.27 2.94 11.8 3.87 0.85 2.54 6.37 0.0 20.25 10.59 17.46 1.1
         2.9 4.29 1.2 1.22 10.1])
 (RatecodeID . [1 2 1 1 1 1 1 1 1 1 1 2 1 2 1 1 1 1 1 1])
 (store_and_fwd_flag
  . ["N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N" "N"
     "N"])
 (PULocationID
  . [138 132 138 138 211 132 79 140 114 132 233 132 138 132 229 233 237 234 230
         138])
 (DOLocationID
  . [74 142 48 229 97 155 263 262 50 197 233 140 65 265 163 148 125 186 230 239])
 (payment_type . [1 1 1 1 1 1 1 1 1 1 3 1 1 2 1 1 1 2 2 1])
 (fare_amount
  . [29.6 70.0 43.6 38.7 17.0 44.3 17.7 5.8 14.2 26.8 3.7 70.0 43.6 70.0 8.6
          14.2 21.9 9.3 9.3 40.1])
 (extra
  . [7.75 4.25 6.0 6.0 1.0 1.0 1.0 1.0 1.0 1.0 0.0 0.0 6.0 0.0 4.25 4.25 1.0 1.0
          1.0 10.25])
 (mta_tax
  . [0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5
         0.5])
 (tip_amount
  . [9.0 5.0 10.87 14.1 3.0 14.05 4.69 2.16 3.99 5.86 0.0 56.2 10.22 0.0 2.85
         4.0 0.0 0.0 0.0 11.75])
 (tolls_amount
  . [6.94 0.0 0.0 6.94 0.0 0.0 0.0 0.0 0.0 0.0 0.0 6.94 0.0 6.94 0.0 0.0 0.0 0.0
          0.0 6.94])
 (improvement_surcharge
  . [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0
         1.0])
 (total_amount
  . [54.79 80.75 66.97 72.24 25.75 60.85 28.14 12.96 23.94 36.91 9.45 138.89
           63.07 83.44 17.2 23.95 27.65 15.05 15.05 70.54])
 (congestion_surcharge
  . [0.0 2.5 2.5 2.5 2.5 0.0 2.5 2.5 2.5 0.0 2.5 2.5 0.0 2.5 2.5 2.5 2.5 2.5 2.5
         2.5])
 (Airport_fee
  . [1.75 1.75 1.75 1.75 0.0 0.0 0.0 0.0 0.0 1.75 0.0 1.75 1.75 1.75 0.0 0.0 0.0
          0.0 0.0 1.75])
 (cbd_congestion_fee
  . [0.0 0.0 0.75 0.75 0.75 0.0 0.75 0.0 0.75 0.0 0.75 0.0 0.0 0.75 0.75 0.75
         0.75 0.75 0.75 0.0]))
#+end_src
